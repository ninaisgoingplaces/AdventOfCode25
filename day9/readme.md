The second part was really hard. 
I don't think my solution is elegant and surely it is not efficient.

Takes approx 5 min runtime on my macbook.
